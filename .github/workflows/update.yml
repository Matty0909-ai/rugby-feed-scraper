name: Update rugby feeds

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hourly updates

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clean workspace
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          rm -f yarn.lock

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Fetch raw API-SPORTS games JSON via curl
        env:
          RUGBY_API_KEY: ${{ secrets.RUGBY_API_KEY }}
        run: |
          mkdir -p data/raw
          echo "Calling API-SPORTS with curl..."
          curl -sS \
            -H "x-apisports-key: ${RUGBY_API_KEY}" \
            "https://v1.rugby.api-sports.io/games?league=76&season=2023" \
            -o data/raw/apisports-games.json

          echo "Saved raw JSON to data/raw/apisports-games.json"
          echo "First 400 bytes of response:"
          head -c 400 data/raw/apisports-games.json || echo "no file"

      - name: Run scraper
        run: npm run update

      - name: Show generated files
        run: |
          echo "==== FIXTURES ===="
          cat data/fixtures.json || echo "no fixtures.json"
          echo
          echo "==== RESULTS ===="
          cat data/results.json || echo "no results.json"
          echo
          echo "==== RAW ===="
          ls -R data/raw
